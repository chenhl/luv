function updateCartTotal(){var productTotal=parseFloat($("#product-total-js").data("product-total"));var shippingCost=parseFloat($("#shipping-cost-js").data("shipping-cost"));var couponCost=parseFloat($("#coupon-cost-js").data("coupon-cost"));var grandTotal=productTotal+shippingCost-couponCost;$("#grand-total-js").text(I18nHelper.formatCurrency(grandTotal,currencyInfo.code))}function collectAddressData(){var result={success:true,data:{},error:{}};$("#address-form input, #address-form select").each(function(){var $this=$(this);if(!checkAddressInput($this)){result.success=false;result.error=$this;return false}else{if(typeof $this.attr("name")!="undefined"){result.data[$this.attr("name")]=$this.val()}}});return result}function checkAddressInput($input){const value=$input.val();const required=$input.prop("required");if(required&&value===""){return false}if($input.attr("name")=="editForm[email]"){if(!check_email(value)){return false}}return true}function loadStatesByCountry(country){$.get(changeCountryUrl,{country:country}).done(function(data){$("#address-state-js").html(data.stateHtml)}).fail(function(){alert("Failed to load states")})}function loadAddressList(addressId=null){var url=addressListUrl;if(addressId){url+="?address_id="+addressId}$.get(url).done(function(data){$("#address-list-js").html(data.html)}).fail(function(){alert("Failed to load address list")})}function openAddressForm(addressId=null){const listOffcanvas=bootstrap.Offcanvas.getInstance(document.getElementById("offcanvasAddressList"));if(listOffcanvas)listOffcanvas.hide();document.getElementById("offcanvasAddressList").addEventListener("hidden.bs.offcanvas",function handler(){var url=addressFormUrl;if(addressId){$("#addressFormLabel").text(translations.titleAddressFormEdit);url=addressFormUrl+"?address_id="+addressId}else{$("#addressFormLabel").text(translations.titleAddressFormAdd)}$.get(url).done(function(html){$("#addressFormOffcanvas .offcanvas-body").html(html.html);if(addressId){$("#addressFormOffcanvas").data("address-id",addressId)}const formOffcanvas=new bootstrap.Offcanvas(document.getElementById("addressFormOffcanvas"));formOffcanvas.show()}).fail(function(){alert("Failed to load address form")});this.removeEventListener("hidden.bs.offcanvas",handler)})}$(document).ready(function(){$("#checkout-order-form").on("submit",function(e){const $form=$(this);const $btn=$("#btn-place-order-js");if($form.data("submitting")){e.preventDefault();return false}var order_remark=$("#order-remark-js").val();if(order_remark.length>order_remark_max_length){showToast(order_remark_message,"#toast-js");$("#order-remark-js").focus();return false}$form.data("submitting",true);$btn.prop("disabled",true).text(translations.restIng)});$("#offcanvasShipping").on("change",".shipping-method-item-js",function(){const $this=$(this);const shippingName=$this.data("name");const shippingFee=$this.data("fee");const selectedId=$this.val();$("#current-shipping-name-js").text(shippingName);$("#current-shipping-method-js").val(selectedId);$("#current-shipping-fee-js").text(I18nHelper.formatCurrency(shippingFee,currencyInfo.code));$("#shipping-cost-js").data("shipping-cost",shippingFee).text(I18nHelper.formatCurrency(shippingFee,currencyInfo.code));$.post(updateCartShippingUrl,{shipping_method:selectedId,[csrfName]:csrfVal}).done(function(data){if(data.status==="success"){}else{}}).fail(function(){});updateCartTotal();bootstrap.Offcanvas.getInstance(document.getElementById("offcanvasShipping"))?.hide()});$("#openAddressFormBtn").on("click",function(){openAddressForm();return false});$(document).on("click",".address-item-edit-js",function(){const id=$(this).data("address-id");openAddressForm(id);return false});$(document).on("change",'.address-item-js [type="radio"]',function(){var $this=$(this);var $item=$this.closest(".address-item-js");var address_id=$this.val();$("#current-address-id-js").val(address_id);$("#current-address-name-js").text($item.find(".address-item-name-js").text());$("#current-address-full-js").text($item.find(".address-item-full-js").text());$.post(updateCartAddressUrl,{address_id:address_id,[csrfName]:csrfVal}).done(function(data){if(data.status==="success"){}else{}}).fail(function(){});bootstrap.Offcanvas.getInstance(document.getElementById("offcanvasAddressList"))?.hide()});document.getElementById("addressFormOffcanvas").addEventListener("hidden.bs.offcanvas",function(){var address_id=$("#current-address-id-js").val();loadAddressList(address_id);const list=new bootstrap.Offcanvas(document.getElementById("offcanvasAddressList"));list.show()});var pendingDeleteAddressId=null;$("#removeDialog").on("show.bs.modal",function(event){var button=$(event.relatedTarget);pendingDeleteAddressId=button.data("address-id")});$("#removeDialog .btn-danger").on("click",function(){if(pendingDeleteAddressId){$("#removeDialog").modal("hide");$.post(addressRemoveUrl,{address_id:pendingDeleteAddressId,[csrfName]:csrfVal}).done(function(data){if(data.status==="success"){bootstrap.Offcanvas.getInstance(document.getElementById("addressFormOffcanvas"))?.hide()}else{alert(data.message||"Error")}}).fail(function(){alert("Failed to delete address")});pendingDeleteAddressId=null}});$("#countryModal").on("show.bs.modal",function(e){const currentCode=$("#country-code-input-js").val();$(".country-item-js .country-checked-js").remove();if(currentCode){const $item=$('.country-item-js[data-code="'+currentCode+'"]');if($item.length){$item.find("span").after('<span class="country-checked-js"><i class="fa-solid fa-check text-danger"></i></span>');const $group=$item.closest(".alphabet-group-js");if($group.length){$group.removeClass("d-none")}setTimeout(()=>{$item[0].scrollIntoView({behavior:"smooth",block:"center"})},100);return}}setTimeout(()=>{document.getElementById("common-group-js")?.scrollIntoView({behavior:"smooth",block:"start"})},100)});$(document).on("click",".alphabet-js",function(){const letter=$(this).attr("rel");const $group=$("#alphabet-"+letter);if($group.hasClass("d-none")){$group.removeClass("d-none")}$group[0].scrollIntoView({behavior:"smooth",block:"start"})});$(document).on("click",".country-item-js",function(){const code=$(this).data("code");const name=$(this).data("name");$("#country-code-input-js").val(code);$("#country-name-input-js").val(name);$("#countryModal").modal("hide");loadStatesByCountry(code)});$(document).on("change","#is-default-input-js",function(){$(this).val(this.checked?1:2)});$(document).on("focus","#address-form input:not([readonly])",function(){$(this).removeClass("is-invalid");$(this).next().removeClass("d-block")}).on("blur","#address-form input:not([readonly])",function(){if(!checkAddressInput($(this))){$(this).addClass("is-invalid");$(this).next().addClass("d-block")}});$(document).on("click","#btn-save-address-js",function(){var $btn=$(this);if($btn.prop("disabled")){return false}$btn.prop("disabled",true).text(translations.savIng);var addressData=collectAddressData();if(!addressData.success){$(this).prop("disabled",false).text(translations.save);addressData.error.addClass("is-invalid");addressData.error.next().addClass("d-block");return false}$.ajax({url:addressSaveUrl,timeout:6e3,dataType:"json",type:"post",data:addressData.data,success:function(data){$btn.prop("disabled",false).text(translations.save);if(data.status=="success"){bootstrap.Offcanvas.getInstance(document.getElementById("addressFormOffcanvas"))?.hide();if(addressData.data["editForm[address_id]"]){showToast(translations.toastUpdateAdressSuccess,"#toast-js")}else{showToast(translations.toastAddAdressSuccess,"#toast-js")}}else{alert(data.message)}},error:function(XMLHttpRequest,textStatus,errorThrown){alert("Oops! Something went wrong. Please try again in a few minutes.");$btn.prop("disabled",false).text(translations.save)}})});$(document).on("change",'.coupon-item-js input[name="coupon_items"]',function(){var coupon_code=$(this).val();var coupon_cost=$(this).data("coupon-cost");$("#current-coupon-cost-input-js").val(coupon_code);$("#current-coupon-cost-js").text("-"+I18nHelper.formatCurrency(coupon_cost,currencyInfo.code));$("#coupon-cost-js").data("coupon-cost",coupon_cost).text("-"+I18nHelper.formatCurrency(coupon_cost,currencyInfo.code));$.post(updateCartCouponUrl,{coupon_code:coupon_code,[csrfName]:csrfVal}).done(function(data){if(data.status==="success"){}else{}}).fail(function(){});updateCartTotal();bootstrap.Offcanvas.getInstance(document.getElementById("offcanvasCoupon"))?.hide()});$("#btn-coupon-apply-js").on("click",function(){var $btn=$(this);if($btn.prop("disabled")){return false}$btn.prop("disabled",true).text(translations.applyIng);var coupon_code=$("#coupon-code-js").val().trim();if(coupon_code==""){$btn.prop("disabled",false).text(translations.apply);showToast(translations.couponCodeRequired,"#toast-js");return false}var $data={coupon_code:coupon_code,select_coupon:true};$data[csrfName]=csrfVal;var product_items=[];var spu,attr_group,base_product_row_price;$(".product_info_coupon-js").each(function(){spu=$(this).data("spu");attr_group=$(this).data("attr-group");base_product_row_price=$(this).data("base-product-row-price");var item={};item["spu"]=spu;item["attr_group"]=attr_group;item["base_product_row_price"]=base_product_row_price;product_items.push(item)});$data["product_items"]=product_items;$.ajax({timeout:6e3,dataType:"json",type:"post",data:$data,url:applyCouponUrl,success:function(data,textStatus){$btn.prop("disabled",false).text(translations.apply);if(data.status=="customer_available"){$("#coupon-available-count").val(data.listCount);$(".coupon-available-count-js").text(data.listCount);$("#current-coupon-cost-input-js").val(data.coupon_code);$("#current-coupon-cost-js").text("-"+I18nHelper.formatCurrency(data.cost,currencyInfo.code));$("#coupon-cost-js").data("coupon-cost",data.cost).text("-"+I18nHelper.formatCurrency(data.cost,currencyInfo.code));var $ele=$("#tab-available").find(".coupon-list-js");$ele.html(data.html);updateCartTotal();bootstrap.Offcanvas.getInstance(document.getElementById("offcanvasCoupon"))?.hide()}else if(data.status=="customer_unavailable"){$("#coupon-unavailable-count").val(data.listCount);var $ele=$("#tab-unavailable").find(".coupon-list-js");$ele.html(data.html);$("#unavailable-tab").click();showToast(data.message,"#toast-js")}else{showToast(data.message,"#toast-js")}$("#coupon-code-js").val("")},error:function(XMLHttpRequest,textStatus,errorThrown){alert(translations.systemError);$btn.prop("disabled",false).text(translations.apply)}})})});