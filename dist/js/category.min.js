function resetUrl(){var url=category_url;var path="";if(url_path_filter_field.length>0){path+="/"+url_path_filter_field.join("/")}if(url_path_filter.length>0){path+="/"+url_path_filter.join("/")}path+="/p"+pageNum;url+=path;url+=window.location.search;return url}$(document).ready(function(){const lazyLoadInstance=new LazyLoad({});$(document).on("click","#filter-reset-js",function(){window.location.href=category_url});$(document).on("click","#apply-filter-js",function(){var url=new URL(category_url,window.location.origin);var params=new URLSearchParams;var keyword=$("#filter-keyword-js").val().trim();if(keyword)params.set("q",keyword);var begin=$("#filter-price-min-js").val().trim();var end=$("#filter-price-max-js").val().trim();var priceValid=val=>{let n=parseFloat(val);return!isNaN(n)&&n>=0};if(begin&&priceValid(begin)||end&&priceValid(end)){let min=begin&&priceValid(begin)?parseFloat(begin):0;let max=end&&priceValid(end)?parseFloat(end):0;params.set("price",min+"-"+max)}$(".filter-attr-js").each(function(){var attrCode=$(this).data("attr-code");var selectedIds=[];$(this).find(".filter-value-item-js.active").each(function(){selectedIds.push($(this).data("value-id"))});if(selectedIds.length>0){params.set(attrCode,selectedIds.join(","))}});url.search=params.toString();window.location.href=url.toString()});$(document).on("click",".filter-value-item-js",function(){var $item=$(this);var attrCode=$item.closest(".filter-attr-js").data("attr-code");var valueName=$item.text().replace(/\s*✓\s*$/,"").trim();var valueId=$item.data("value-id");if($item.hasClass("active")){$item.removeClass("active bg-primary text-white").find("i").remove();var idx=selected_attr_values_map[attrCode].indexOf(valueName);if(idx!==-1)selected_attr_values_map[attrCode].splice(idx,1)}else{if(selected_attr_values_map[attrCode].length>=10){alert("You can select up to ten items");return}$item.addClass("active bg-primary text-white").append('<i class="fas fa-check ms-2"></i>');selected_attr_values_map[attrCode].push(valueName)}});let isLoading=false;function loadMoreProducts(){if(pageNum>=maxPage){console.log("已到达最后一页，停止加载");if(observer&&document.getElementById("load-trigger")){observer.unobserve(document.getElementById("load-trigger"))}$("#product-list-more").append('<div class="col-12 text-center text-muted">No more products.</div>');return}if(isLoading)return;isLoading=true;$("#product-list-more").append('<div id="loading-more" class="col-12 text-center my-3">Loading...</div>');$.ajax({url:resetUrl(),method:"GET",data:{},dataType:"json",timeout:5e3}).done(function(response){if(response.html&&response.html.trim()!==""){$("#product-list-more").append(response.html);lazyLoadInstance.update();pageNum=response.next_page}else{observer.unobserve(document.getElementById("load-trigger"));$("#product-list-more").append('<div class="col-12 text-center text-muted">No more products.</div>')}}).fail(function(){alert("Failed to load more products.")}).always(function(){$("#loading-more").remove();isLoading=false})}const throttledLoad=_.throttle(function(){if(!isLoading){loadMoreProducts()}},1e3,{trailing:true});const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting){throttledLoad()}},{rootMargin:"100px"});if(document.getElementById("load-trigger")){observer.observe(document.getElementById("load-trigger"))}});